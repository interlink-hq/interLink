---
sidebar_position: 9
---

# Virtual Kubelet Certificate Management

This guide covers certificate management options for InterLink's virtual-kubelet HTTPS server. The virtual-kubelet provides multiple ways to manage its server certificates, from automatic Kubernetes-native certificate management to simple self-signed certificates.

## Overview

The virtual-kubelet runs an HTTPS server that needs valid TLS certificates. InterLink supports two certificate management modes:

1. **CSR-based certificates** - Uses Kubernetes Certificate Signing Request API (recommended)
2. **Self-signed certificates** - Automatically generated self-signed certificates (default)

## CSR-Based Certificate Management (Recommended)

### What is CSR-Based Certificate Management?

CSR (Certificate Signing Request) based certificate management leverages Kubernetes' built-in certificate management infrastructure. The virtual-kubelet automatically:

- Generates private keys
- Creates certificate signing requests
- Submits CSRs to the Kubernetes API server
- Manages certificate lifecycle and renewal

### Benefits

- **Kubernetes-native**: Integrates with cluster's certificate management
- **Automatic rotation**: Certificates are renewed automatically before expiration
- **Proper CA chain**: Certificates signed by the cluster's certificate authority
- **Standard compliance**: Follows the same patterns as real Kubernetes nodes
- **Better security**: No manual certificate management required

### Configuration

To enable CSR-based certificates, add the following to your virtual-kubelet configuration:

```yaml title="VirtualKubeletConfig.yaml"
# Enable CSR-based certificate management
KubeletHTTPSCertMode: "csr"

# Standard virtual-kubelet configuration
InterlinkURL: https://your-interlink-server
InterlinkPort: "3000"
Resources:
  CPU: "8"
  Memory: "16Gi"
  Pods: "100"
```

### Requirements

1. **RBAC Permissions**: The virtual-kubelet service account needs permissions to create and manage CSRs:

```yaml title="csr-permissions.yaml"
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: virtual-kubelet-csr
rules:
- apiGroups: ["certificates.k8s.io"]
  resources: ["certificatesigningrequests"]
  verbs: ["create", "get", "list", "watch"]
- apiGroups: ["certificates.k8s.io"]
  resources: ["certificatesigningrequests/approval"]
  verbs: ["update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: virtual-kubelet-csr
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: virtual-kubelet-csr
subjects:
- kind: ServiceAccount
  name: virtual-kubelet
  namespace: interlink
```

2. **Cluster Configuration**: The cluster must have the `kubernetes.io/kubelet-serving` signer available and configured.

3. **CSR Approval**: Depending on your cluster configuration, CSRs may need manual approval:

```bash
# Check pending CSRs
kubectl get csr

# Approve virtual-kubelet CSRs
kubectl certificate approve <csr-name>
```

### Certificate Details

When using CSR mode, certificates will have:
- **Subject**: `CN=system:node:<node-name>, O=system:nodes`
- **SANs**: Node IP address, node name, and `<node-name>.local`
- **Key Usage**: Digital Signature, Key Encipherment, Server Auth
- **Validity**: 1 year (automatically renewed)

## Self-Signed Certificate Management (Default)

### What are Self-Signed Certificates?

Self-signed certificates are automatically generated by the virtual-kubelet without requiring any external certificate authority. This is the default mode for backward compatibility.

### When to Use Self-Signed Certificates

- Quick development and testing setups
- Environments where CSR approval workflow is not desired
- Clusters without proper certificate signing infrastructure
- When you need minimal configuration

### Configuration

Self-signed mode is the default. You can explicitly configure it:

```yaml title="VirtualKubeletConfig.yaml"
# Explicit self-signed mode (optional - this is the default)
KubeletHTTPSCertMode: "self-signed"

# Or simply omit the KubeletHTTPSCertMode field entirely
InterlinkURL: https://your-interlink-server
InterlinkPort: "3000"
```

### Certificate Details

Self-signed certificates have:
- **Subject**: `CN=system:node:<node-name>, O=intertwin.eu`
- **SANs**: Node IP address
- **Key Usage**: Digital Signature, Client Auth, Server Auth
- **Validity**: 1 year (automatically renewed when near expiration)
- **Algorithm**: Ed25519

## Helm Chart Configuration

### CSR Mode

```yaml title="values.yaml"
# Enable CSR-based certificates
virtualKubelet:
  config:
    KubeletHTTPSCertMode: "csr"

# Ensure proper RBAC permissions
rbac:
  create: true
  extraRules:
    - apiGroups: ["certificates.k8s.io"]
      resources: ["certificatesigningrequests"]
      verbs: ["create", "get", "list", "watch"]
    - apiGroups: ["certificates.k8s.io"]
      resources: ["certificatesigningrequests/approval"]
      verbs: ["update"]
```

### Self-Signed Mode

```yaml title="values.yaml"
# Use self-signed certificates (default)
virtualKubelet:
  config:
    KubeletHTTPSCertMode: "self-signed"
    # or omit this field entirely
```

## Troubleshooting

### CSR Mode Issues

1. **CSR Creation Failures**
   ```bash
   # Check virtual-kubelet logs
   kubectl logs -n interlink deployment/virtual-kubelet
   
   # Check RBAC permissions
   kubectl auth can-i create certificatesigningrequests --as=system:serviceaccount:interlink:virtual-kubelet
   ```

2. **Pending CSRs**
   ```bash
   # List pending CSRs
   kubectl get csr | grep Pending
   
   # Approve specific CSR
   kubectl certificate approve virtual-kubelet-csr-<id>
   ```

3. **Certificate Renewal Issues**
   ```bash
   # Check certificate expiration
   kubectl get csr | grep virtual-kubelet
   
   # Delete old CSRs to trigger renewal
   kubectl delete csr <old-csr-name>
   ```

### Self-Signed Mode Issues

1. **Certificate Trust Issues**
   - Self-signed certificates will show as untrusted in browsers
   - Use `--insecure` flag or proper CA configuration for clients

2. **Certificate Regeneration**
   - Certificates are automatically regenerated before expiration
   - To force regeneration, restart the virtual-kubelet pod

### General Debugging

```bash
# Check virtual-kubelet server certificate
openssl s_client -connect <virtual-kubelet-ip>:10250 -servername <node-name>

# Verify certificate details
echo | openssl s_client -connect <virtual-kubelet-ip>:10250 2>/dev/null | openssl x509 -text -noout
```

## Migration Between Modes

### From Self-Signed to CSR

1. Update configuration to use CSR mode
2. Ensure RBAC permissions are configured
3. Restart virtual-kubelet
4. Approve any pending CSRs if needed

### From CSR to Self-Signed

1. Update configuration to use self-signed mode
2. Restart virtual-kubelet
3. Clean up old CSRs (optional):
   ```bash
   kubectl delete csr -l app=virtual-kubelet
   ```

## Security Considerations

### CSR Mode Security

- CSRs are automatically approved by the certificate manager
- Certificates are stored in `/tmp/certs` inside the container
- Private keys are generated using secure random sources
- Regular certificate rotation minimizes exposure window

### Self-Signed Mode Security

- Certificates are not verified by external CA
- Suitable for internal/development use
- Consider using CSR mode for production deployments
- Private keys are ephemeral and container-local

## Best Practices

1. **Use CSR mode for production** - Better security and integration
2. **Monitor certificate expiration** - Set up alerts for certificate renewal
3. **Configure proper RBAC** - Limit CSR permissions to necessary scope
4. **Regular updates** - Keep virtual-kubelet updated for security patches
5. **Backup considerations** - Certificates are automatically managed, no backup needed